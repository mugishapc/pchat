{% extends "base.html" %}

{% block content %}
    <!-- App Launching Animation -->
    <div id="app-launch" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #667eea; display: flex; justify-content: center; align-items: center; z-index: 9999;">
        <div style="text-align: center; color: white;">
            <div style="width: 80px; height: 80px; background: white; border-radius: 50%; margin: 0 auto 20px; display: flex; justify-content: center; align-items: center;">
                <span style="font-size: 40px; color: #667eea; font-weight: bold;">M</span>
            </div>
            <h1 style="margin-bottom: 10px;">MugiChat</h1>
            <p>Loading...</p>
        </div>
    </div>

    <!-- Chat List Template -->
    <div id="chat-list-template">
        <div class="chat-list-container">
            <header class="chat-header">
                <h1>MugiChat</h1>
                <div class="user-info">
                    <span id="welcome-user">Welcome, {{ username }}</span>
                    <a href="{{ url_for('logout') }}" id="logout-btn" class="logout-btn">Logout</a>
                    <button id="delete-account-btn" class="delete-btn">Delete Account</button>
                </div>
            </header>
            
            <div class="chat-list-content">
                <div class="chat-list-header">
                    <h2>Chats</h2>
                    <p>The app by Mpc!</p>
                    <button id="new-chat-btn" class="new-chat-btn">+ New Chat</button>
                </div>
                
                <div class="users-panel" id="users-panel" style="display: none;">
                    <div class="users-header">
                        <button id="back-to-chats" class="back-btn">← Back</button>
                        <h3>Select a user</h3>
                    </div>
                    <ul id="users-list">
                        {% for user in users %}
                        <li data-user-id="{{ user.id }}">
                            <a href="#" class="user-item">
                                <span class="user-avatar">{{ user.username[0].upper() }}</span>
                                <span class="user-name">{{ user.username }}</span>
                                <span class="user-status" data-user-id="{{ user.id }}"></span>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                
                <div class="conversations-panel" id="conversations-panel">
                    <ul id="conversations-list">
                        {% for conversation in conversations %}
                        <li data-conversation-id="{{ conversation.id }}" data-other-user-id="{{ conversation.other_user_id }}">
                            <a href="{{ url_for('chat', conversation_id=conversation.id) }}" class="conversation-item">
                                <span class="user-avatar">{{ conversation.other_username[0].upper() }}</span>
                                <div class="conversation-info">
                                    <span class="user-name">{{ conversation.other_username }}</span>
                                    <span class="last-message">{{ conversation.last_message|truncate(20) if conversation.last_message else '' }}</span>
                                </div>
                                <div class="conversation-meta">
                                    <span class="last-message-time">{{ conversation.last_message_time|format_time if conversation.last_message_time else '' }}</span>
                                    {% if conversation.unread_count > 0 %}
                                    <span class="unread-badge">{{ conversation.unread_count }}</span>
                                    {% endif %}
                                </div>
                                <button class="delete-conversation-btn" data-conversation-id="{{ conversation.id }}">×</button>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden field for VAPID public key -->
    <input type="hidden" id="vapid-public-key" value="{{ vapid_public_key }}">
{% endblock %}

{% block scripts %}
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // Global variables
        let socket;
        let currentUserId = null;
        let userStatuses = {};
        
        // DOM elements
        const logoutBtn = document.getElementById('logout-btn');
        const deleteAccountBtn = document.getElementById('delete-account-btn');
        const appLaunch = document.getElementById('app-launch');
        const chatListTemplate = document.getElementById('chat-list-template');
        const newChatBtn = document.getElementById('new-chat-btn');
        const usersPanel = document.getElementById('users-panel');
        const conversationsPanel = document.getElementById('conversations-panel');
        const backToChatsBtn = document.getElementById('back-to-chats');
        
        // Check if user is already logged in
        document.addEventListener('DOMContentLoaded', function() {
            // Show app launching animation
            setTimeout(() => {
                appLaunch.style.opacity = '0';
                setTimeout(() => {
                    appLaunch.style.display = 'none';
                    chatListTemplate.style.display = 'block';
                    
                    checkAuthStatus();
                }, 500);
            }, 2000);
        });
        
        function checkAuthStatus() {
            fetch('/check_auth', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.authenticated) {
                    currentUserId = data.user_id;
                    loadUserStatuses();
                    
                    // Set up user and conversation click events
                    setupUserAndConversationEvents();
                    
                    // Set up logout and delete account buttons
                    setupButtonEvents();
                    
                    // Initialize service worker for PWA
                    initializeServiceWorker();
                    
                    // Listen for online/offline status
                    setupNetworkStatusListener();
                } else {
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error('Auth check error:', error);
                window.location.href = '/login';
            });
        }
        
        function loadUserStatuses() {
            fetch('/users/status', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                userStatuses = data;
                updateAllUserStatusIndicators();
            })
            .catch(error => {
                console.error('Error loading user statuses:', error);
            });
        }
        
        function updateAllUserStatusIndicators() {
            // Update status for all users in the list
            document.querySelectorAll('.user-item').forEach(item => {
                const userId = item.closest('li').getAttribute('data-user-id');
                updateUserStatusIndicator(userId);
            });
        }
        
        function updateUserStatusIndicator(userId) {
            const statusElement = document.querySelector(`.user-status[data-user-id="${userId}"]`);
            if (statusElement && userStatuses[userId]) {
                const status = userStatuses[userId].status;
                statusElement.className = `user-status ${status}`;
                statusElement.title = status === 'online' ? 'Online' : 
                                    status === 'recently online' ? 'Recently online' : 'Offline';
            }
        }
        
        function setupUserAndConversationEvents() {
            // New chat button
            newChatBtn.addEventListener('click', function() {
                usersPanel.style.display = 'block';
                conversationsPanel.style.display = 'none';
            });
            
            // Back to chats button
            backToChatsBtn.addEventListener('click', function() {
                usersPanel.style.display = 'none';
                conversationsPanel.style.display = 'block';
            });
            
            document.querySelectorAll('.user-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const userId = this.closest('li').getAttribute('data-user-id');
                    const username = this.querySelector('.user-name').textContent;
                    startConversation(userId, username);
                });
            });
            
            // Delete conversation buttons
            document.querySelectorAll('.delete-conversation-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const conversationId = this.getAttribute('data-conversation-id');
                    deleteConversation(conversationId);
                });
            });
        }
        
        function setupButtonEvents() {
            // Logout button
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                fetch('/logout', {
                    method: 'GET',
                    credentials: 'include'
                })
                .then(() => {
                    if (socket) socket.disconnect();
                    window.location.href = '/login';
                });
            });
            
            // Delete account button
            deleteAccountBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete your account? This will permanently delete all your messages and cannot be undone.')) {
                    fetch('/delete_account', {
                        method: 'POST',
                        credentials: 'include'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Account deleted successfully');
                            window.location.href = '/login';
                        } else {
                            alert('Error deleting account: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting account:', error);
                        alert('Error deleting account. Please try again.');
                    });
                }
            });
        }
        
        function startConversation(userId, username) {
            fetch(`/conversation/${userId}`, {
                method: 'POST',
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to create conversation');
                }
                return response.json();
            })
            .then(data => {
                // Redirect to the chat screen
                window.location.href = `/chat/${data.conversation_id}`;
            })
            .catch(error => {
                console.error('Error starting conversation:', error);
                alert('Error starting conversation. Please try again.');
            });
        }
        
        function deleteConversation(conversationId) {
            if (confirm('Are you sure you want to delete this conversation? All messages will be deleted.')) {
                fetch(`/delete_conversation/${conversationId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove from UI
                        const convItem = document.querySelector(`#conversations-list li[data-conversation-id="${conversationId}"]`);
                        if (convItem) {
                            convItem.remove();
                        }
                    } else {
                        alert('Error deleting conversation');
                    }
                })
                .catch(error => {
                    console.error('Error deleting conversation:', error);
                    alert('Error deleting conversation. Please try again.');
                });
            }
        }
        
        function initializeServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('{{ url_for("static", filename="service-worker.js") }}')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            }
        }
        
        function setupNetworkStatusListener() {
            window.addEventListener('online', function() {
                showStatus('Back online', 'success');
            });
            
            window.addEventListener('offline', function() {
                showStatus('You are offline, Just connect to the network please', 'error');
            });
            
            // Initial check
            if (!navigator.onLine) {
                showStatus('You are offline, Just connect to the network please', 'error');
            }
        }
        
        function showStatus(message, type) {
            // Create or show a status notification
            let statusEl = document.getElementById('network-status');
            if (!statusEl) {
                statusEl = document.createElement('div');
                statusEl.id = 'network-status';
                statusEl.style.position = 'fixed';
                statusEl.style.top = '10px';
                statusEl.style.left = '50%';
                statusEl.style.transform = 'translateX(-50%)';
                statusEl.style.padding = '10px 20px';
                statusEl.style.borderRadius = '5px';
                statusEl.style.zIndex = '1000';
                statusEl.style.fontWeight = 'bold';
                document.body.appendChild(statusEl);
            }
            
            statusEl.textContent = message;
            statusEl.style.backgroundColor = type === 'success' ? '#4caf50' : '#f44336';
            statusEl.style.color = 'white';
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }
    </script>
{% endblock %}