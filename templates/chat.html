{% extends "base.html" %}

{% block content %}
    <!-- Chat Screen Template -->
    <div id="chat-screen-template">
        <div class="chat-screen-container">
            <header class="chat-header">
                <a href="{{ url_for('index') }}" class="back-btn">‚Üê Back</a>
                <div class="chat-info">
                    <h2 id="current-chat-with">Chat with {{ other_user.username }}</h2>
                    <span id="current-chat-status" class="chat-status"></span>
                </div>
                <div id="user-activity-indicator" class="user-activity-indicator" style="display: none;"></div>
                <button id="delete-conversation-btn" class="delete-btn">Delete Chat</button>
            </header>
            
            <div class="chat-messages" id="chat-messages">
                <!-- Messages will be loaded here -->
                <div class="empty-chat">
                    <p>No messages yet. Start the conversation!</p>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="input-group">
                    <button id="toggle-input-btn" class="toggle-input-btn">üé§</button>
                    <input type="text" id="message-input" placeholder="Type your message...">
                    <button id="send-btn" class="send-btn">‚û§</button>
                </div>
                
                <!-- Audio Recording UI -->
                <div class="audio-recording-ui" id="audio-recording-ui" style="display: none;">
                    <div class="recording-visualizer">
                        <div class="recording-dot"></div>
                        <span class="recording-text">Recording...</span>
                        <span class="recording-timer" id="recording-timer">00:00</span>
                    </div>
                    <div class="recording-controls">
                        <button id="cancel-recording-btn" class="cancel-btn">‚úï Cancel</button>
                        <button id="send-recording-btn" class="send-audio-btn">Send</button>
                    </div>
                    <div class="recording-hint">
                        ‚Üë Release to send ‚Ä¢ ‚Üê Drag to cancel
                    </div>
                </div>
                
                <!-- Audio Message Player Template (Hidden) -->
                <template id="audio-message-template">
                    <div class="audio-message-player">
                        <button class="play-pause-btn">‚ñ∂</button>
                        <div class="audio-progress">
                            <div class="audio-progress-bar"></div>
                        </div>
                        <span class="audio-duration">00:00</span>
                    </div>
                </template>
            </div>
        </div>
    </div>
    
    <!-- Hidden fields -->
    <input type="hidden" id="vapid-public-key" value="{{ vapid_public_key }}">
    <input type="hidden" id="conversation-id" value="{{ conversation.id }}">
    <input type="hidden" id="other-user-id" value="{{ other_user.id }}">
    <input type="hidden" id="other-username" value="{{ other_user.username }}">
{% endblock %}

{% block styles %}
<style>
    /* Audio Recording Styles */
    .audio-recording-ui {
        background: #f0f0f0;
        padding: 15px;
        border-radius: 25px;
        margin: 10px 0;
        text-align: center;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { background: #f0f0f0; }
        50% { background: #e0e0e0; }
        100% { background: #f0f0f0; }
    }
    
    .recording-visualizer {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    .recording-dot {
        width: 12px;
        height: 12px;
        background: #ff3b30;
        border-radius: 50%;
        animation: blink 1s infinite;
    }
    
    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
    }
    
    .recording-text {
        font-weight: bold;
        color: #ff3b30;
    }
    
    .recording-timer {
        font-family: monospace;
        font-weight: bold;
    }
    
    .recording-controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 10px 0;
    }
    
    .cancel-btn, .send-audio-btn {
        padding: 8px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
    }
    
    .cancel-btn {
        background: #ff3b30;
        color: white;
    }
    
    .send-audio-btn {
        background: #007bff;
        color: white;
    }
    
    .recording-hint {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }
    
    /* Audio Message Player */
    .audio-message-player {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 20px;
        max-width: 250px;
    }
    
    .play-pause-btn {
        width: 30px;
        height: 30px;
        border: none;
        border-radius: 50%;
        background: #007bff;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .audio-progress {
        flex: 1;
        height: 4px;
        background: #ddd;
        border-radius: 2px;
        position: relative;
    }
    
    .audio-progress-bar {
        position: absolute;
        height: 100%;
        background: #007bff;
        border-radius: 2px;
        width: 0%;
        transition: width 0.1s linear;
    }
    
    .audio-duration {
        font-size: 12px;
        color: #666;
        min-width: 40px;
    }
    
    /* Message Styles */
    .message.sent .audio-message-player {
        background: #007bff;
        color: white;
    }
    
    .message.sent .play-pause-btn {
        background: white;
        color: #007bff;
    }
    
    .message.sent .audio-progress-bar {
        background: white;
    }
    
    .message.sent .audio-duration {
        color: rgba(255, 255, 255, 0.8);
    }
    
    /* Input Toggle */
    .toggle-input-btn {
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        padding: 10px;
        transition: transform 0.2s;
    }
    
    .toggle-input-btn.recording-mode {
        transform: scale(1.1);
        color: #ff3b30;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .audio-recording-ui {
            margin: 5px;
            padding: 12px;
        }
        
        .audio-message-player {
            max-width: 200px;
        }
        
        .recording-controls {
            flex-direction: column;
            gap: 10px;
        }
    }
</style>
{% endblock %}

{% block scripts %}
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='audio-recorder.js') }}"></script>
    <script>
        // Global variables
        let socket;
        let currentConversationId = document.getElementById('conversation-id').value;
        let currentOtherUserId = document.getElementById('other-user-id').value;
        let currentOtherUsername = document.getElementById('other-username').value;
        let currentUserId = null;
        let currentUsername = '{{ current_user.username }}';
        let audioRecorder = null;
        let typingTimer = null;
        let typingIndicatorTimer = null;
        
        // DOM elements
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const toggleInputBtn = document.getElementById('toggle-input-btn');
        const audioRecordingUI = document.getElementById('audio-recording-ui');
        const recordingTimerEl = document.getElementById('recording-timer');
        const cancelRecordingBtn = document.getElementById('cancel-recording-btn');
        const sendRecordingBtn = document.getElementById('send-recording-btn');
        const deleteConversationBtn = document.getElementById('delete-conversation-btn');
        const userActivityIndicator = document.getElementById('user-activity-indicator');
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });
        
        function checkAuthStatus() {
            fetch('/check_auth', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.authenticated) {
                    currentUserId = data.user_id;
                    initializeSocket();
                    loadMessages();
                    loadUserStatus();
                    initializeAudioRecorder();
                    setupChatEvents();
                } else {
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error('Auth check error:', error);
                window.location.href = '/login';
            });
        }
        
        function initializeAudioRecorder() {
            const recordingStatus = document.createElement('div');
            recordingStatus.className = 'recording-status';
            
            audioRecorder = new AudioRecorder(
                toggleInputBtn,
                recordingTimerEl,
                (audioBlob, duration) => {
                    sendAudioMessage(audioBlob, duration);
                }
            );
        }
        
        function initializeSocket() {
            socket = io({
                transports: ['websocket', 'polling']
            });
            
            socket.on('connect', function() {
                console.log('Connected to server');
                socket.emit('join_conversation', {conversation_id: currentConversationId});
                
                setInterval(() => {
                    socket.emit('user_activity');
                }, 15000);
            });
            
            socket.on('new_message', function(data) {
                if (data.conversation_id === currentConversationId) {
                    addMessageToChat(data);
                }
            });
            
            socket.on('user_status', function(data) {
                if (data.user_id == currentOtherUserId) {
                    updateChatStatusIndicator(data.status);
                }
            });
            
            socket.on('message_deleted', function(data) {
                if (data.conversation_id === currentConversationId) {
                    const messageElement = document.querySelector(`.message[data-message-id="${data.message_id}"]`);
                    if (messageElement) {
                        messageElement.remove();
                    }
                }
            });
            
            socket.on('user_typing', function(data) {
                if (data.conversation_id === currentConversationId && data.user_id == currentOtherUserId) {
                    showUserActivityIndicator(data.is_typing ? 'typing' : null);
                }
            });
            
            socket.on('user_recording', function(data) {
                if (data.conversation_id === currentConversationId && data.user_id == currentOtherUserId) {
                    showUserActivityIndicator(data.is_recording ? 'recording' : null);
                }
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from server');
            });
        }
        
        function loadMessages() {
            fetch(`/messages/${currentConversationId}`, {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(messages => {
                chatMessages.innerHTML = '';
                
                if (messages.length === 0) {
                    chatMessages.innerHTML = `
                        <div class="empty-chat">
                            <p>No messages yet. Start the conversation!</p>
                        </div>
                    `;
                } else {
                    messages.forEach(addMessageToChat);
                }
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            })
            .catch(error => {
                console.error('Error loading messages:', error);
                if (error.message.includes('401') || error.message.includes('403')) {
                    window.location.href = '/login';
                }
            });
        }
        
        function setupChatEvents() {
            // Send message button
            sendBtn.addEventListener('click', sendMessage);
            
            // Send message on Enter key
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Cancel recording button
            cancelRecordingBtn.addEventListener('click', function() {
                if (audioRecorder) {
                    audioRecorder.cancelRecording();
                    hideAudioUI();
                }
            });
            
            // Send recording button
            sendRecordingBtn.addEventListener('click', function() {
                if (audioRecorder) {
                    audioRecorder.stopRecording();
                    hideAudioUI();
                }
            });
            
            // Typing indicators
            messageInput.addEventListener('input', function() {
                if (messageInput.value.length > 0) {
                    socket.emit('typing_start', {conversation_id: currentConversationId});
                    
                    if (typingTimer) clearTimeout(typingTimer);
                    
                    typingTimer = setTimeout(() => {
                        socket.emit('typing_stop', {conversation_id: currentConversationId});
                    }, 1000);
                } else {
                    socket.emit('typing_stop', {conversation_id: currentConversationId});
                }
            });
            
            // Delete conversation button
            deleteConversationBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this conversation?')) {
                    fetch(`/delete_conversation/${currentConversationId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = '/';
                        } else {
                            alert('Error deleting conversation');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting conversation:', error);
                    });
                }
            });
        }
        
        function showAudioUI() {
            audioRecordingUI.style.display = 'block';
            messageInput.style.display = 'none';
            sendBtn.style.display = 'none';
            toggleInputBtn.classList.add('recording-mode');
        }
        
        function hideAudioUI() {
            audioRecordingUI.style.display = 'none';
            messageInput.style.display = 'block';
            sendBtn.style.display = 'block';
            toggleInputBtn.classList.remove('recording-mode');
            toggleInputBtn.innerHTML = 'üé§';
        }
        
        function addMessageToChat(message) {
            const emptyChat = chatMessages.querySelector('.empty-chat');
            if (emptyChat) emptyChat.remove();
            
            const messageElement = document.createElement('div');
            const isCurrentUser = message.user_id === currentUserId;
            messageElement.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
            messageElement.setAttribute('data-message-id', message.id);
            
            const timestamp = new Date(message.timestamp);
            const timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let messageContent = '';
            
            if (message.type === 'text') {
                messageContent = `<div class="message-content">${message.content}</div>`;
            } else if (message.type === 'audio') {
                messageContent = `
                    <div class="message-content audio-message">
                        <audio controls style="width: 250px; height: 40px;">
                            <source src="${message.content}" type="audio/webm">
                            Your browser does not support audio.
                        </audio>
                    </div>
                `;
            }
            
            let readStatus = '';
            if (isCurrentUser && message.is_read) {
                readStatus = '<span class="read-status">‚úì‚úì</span>';
            } else if (isCurrentUser) {
                readStatus = '<span class="read-status">‚úì</span>';
            }
            
            let deleteButton = '';
            if (isCurrentUser) {
                deleteButton = `<button class="delete-message-btn" data-message-id="${message.id}">Delete</button>`;
            }
            
            messageElement.innerHTML = `
                ${messageContent}
                <div class="message-info">
                    <span class="username">${message.username}</span>
                    <span class="timestamp">${timeString}</span>
                    ${readStatus}
                    ${deleteButton}
                </div>
            `;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            const deleteBtn = messageElement.querySelector('.delete-message-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    const messageId = this.getAttribute('data-message-id');
                    deleteMessage(messageId);
                });
            }
        }
        
        function sendMessage() {
            const message = messageInput.value.trim();
            
            if (message) {
                socket.emit('send_message', {
                    content: message,
                    conversation_id: currentConversationId
                });
                messageInput.value = '';
                socket.emit('typing_stop', {conversation_id: currentConversationId});
            }
        }
        
        function sendAudioMessage(audioBlob, duration) {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.webm');
            formData.append('duration', Math.round(duration / 1000)); // Send duration in seconds
            
            // Show sending indicator
            const tempMessageElement = document.createElement('div');
            tempMessageElement.className = 'message sent';
            tempMessageElement.innerHTML = `
                <div class="message-content audio-message">
                    <div style="padding: 10px; color: #666;">Sending audio...</div>
                </div>
                <div class="message-info">
                    <span class="timestamp">Sending...</span>
                </div>
            `;
            chatMessages.appendChild(tempMessageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            fetch(`/upload_audio/${currentConversationId}`, {
                method: 'POST',
                body: formData,
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                tempMessageElement.remove();
                if (!data.success) {
                    alert('Error sending audio message');
                }
            })
            .catch(error => {
                console.error('Error sending audio:', error);
                tempMessageElement.remove();
                alert('Error sending audio message. Please check your connection.');
            });
        }
        
        function deleteMessage(messageId) {
            fetch(`/delete_message/${messageId}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) alert('Error deleting message');
            })
            .catch(error => console.error('Error deleting message:', error));
        }
        
        function updateChatStatusIndicator(status) {
            const statusElement = document.getElementById('current-chat-status');
            if (statusElement) {
                statusElement.textContent = status === 'online' ? 'online' : 
                                          status === 'recently online' ? 'recently online' : 'offline';
                statusElement.className = `chat-status ${status}`;
            }
        }
        
        function showUserActivityIndicator(activityType) {
            if (typingIndicatorTimer) clearTimeout(typingIndicatorTimer);
            
            if (activityType) {
                if (activityType === 'typing') {
                    userActivityIndicator.textContent = `${currentOtherUsername} is typing...`;
                } else if (activityType === 'recording') {
                    userActivityIndicator.textContent = `${currentOtherUsername} is recording...`;
                }
                userActivityIndicator.style.display = 'block';
                
                typingIndicatorTimer = setTimeout(() => {
                    userActivityIndicator.style.display = 'none';
                }, 3000);
            } else {
                userActivityIndicator.style.display = 'none';
            }
        }
        
        function loadUserStatus() {
            fetch(`/users/status`, {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data[currentOtherUserId]) {
                    updateChatStatusIndicator(data[currentOtherUserId].status);
                }
            })
            .catch(error => console.error('Error loading user status:', error));
        }
    </script>
{% endblock %}